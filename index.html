<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Auditoria Interna - Diamante Lingerie</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');

        body { 
            font-family: 'Inter', 'Segoe UI', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            line-height: 1.4;
            padding-bottom: 100px;
        }

        * { border-radius: 0 !important; }

        /* --- REGRAS CRÍTICAS DE PAGINAÇÃO --- */
        .avoid-break { 
            page-break-inside: avoid !important; 
            break-inside: avoid !important;
            display: block;
            position: relative; 
            margin-bottom: 15px;
        }

        .list-item-separator {
            page-break-inside: avoid !important;
            break-inside: avoid !important;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 8px;
            margin-bottom: 8px;
            display: block;
        }
        
        .section-header-wrapper {
            page-break-after: avoid !important;
            break-after: avoid !important;
            margin-top: 10px;
            margin-bottom: 10px;
        }

        .pdf-page-break { display: none; }

        .printable-area {
            max-width: 950px;
            margin: 1rem auto;
            background: #fff;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        .card-top-main {
            background-color: #7f1d1d !important; 
            color: #ffffff !important;
            border-bottom: 2px solid #000;
        }

        .header-table-grid {
            border: 1.5px solid #000000 !important;
            width: 100%;
            border-collapse: collapse;
        }

        .cell-label {
            background-color: #7f1d1d !important; 
            color: #ffffff !important;
            font-weight: 700;
            font-size: 8px;
            text-transform: uppercase;
            padding: 4px 8px;
            border: 1px solid #000;
        }

        .cell-value {
            background-color: #fff1f2 !important; 
            color: #000000 !important;
            font-weight: 700;
            font-size: 9.5px;
            padding: 4px 8px;
            border: 1px solid #000;
        }

        .section-header {
            font-size: 10px;
            font-weight: 900;
            text-transform: uppercase;
            color: #7f1d1d;
            border-bottom: 2px solid #7f1d1d;
            padding-bottom: 2px;
            margin-bottom: 8px;
        }

        .dynamic-textarea, .rich-editor, input[type="text"] {
            background: transparent;
            width: 100%;
            outline: none;
            font-weight: 700;
        }
        
        .dynamic-textarea, .rich-editor {
            resize: none;
            overflow: hidden; 
            display: block;
            word-wrap: break-word;
            white-space: pre-wrap;
            line-height: 1.4;
            min-height: 1.4em;
        }

        .rich-editor {
            min-height: 60px;
            padding: 8px;
            border: 1px solid #e2e8f0;
            background-color: #fff;
            font-weight: 500;
            font-size: 10px;
        }

        .rich-editor:focus {
            border-color: #7f1d1d;
            background-color: #fff;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
        }

        .rich-editor[placeholder]:empty:before {
            content: attr(placeholder);
            color: #94a3b8;
            cursor: text;
        }

        .pdf-static-text {
            display: block;
            word-wrap: break-word;
            white-space: pre-wrap;
            font-weight: 700;
            font-size: 9.5px;
            line-height: 1.4;
            color: #000;
            width: 100%;
        }

        .risk-btn-selected {
            outline: 2px solid #000;
            z-index: 10;
            transform: scale(1.03);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .resizable-wrapper {
            resize: both;
            overflow: hidden;
            position: relative;
            border: 1px solid #e2e8f0;
            background-color: #fff;
            min-width: 100px;
            min-height: 100px;
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            vertical-align: top;
            max-width: 100%;
        }
        
        .resizable-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            pointer-events: none;
        }

        .layout-toolbar {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 100;
        }

        .discreet-btn {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(4px);
            border: 1px solid #e2e8f0;
            color: #475569;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .discreet-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            color: #1e293b;
            border-color: #cbd5e1;
        }
        
        .btn-active {
            background-color: #eff6ff;
            border-color: #3b82f6;
            color: #1d4ed8;
        }
        
        .btn-pdf:hover {
            color: #b91c1c;
            border-color: #fca5a5;
            background-color: #fef2f2;
        }

        .draggable-item {
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .draggable-item:active {
            cursor: grabbing;
        }

        .dragging {
            opacity: 0.5;
            background: #f1f5f9;
            border: 2px dashed #94a3b8;
        }

        .drag-over {
            border-top: 3px solid #3b82f6 !important;
            margin-top: 5px;
        }

        .manual-break {
            border-top: 2px dashed #ef4444;
            margin: 10px 0;
            height: 30px;
            background-color: #fef2f2;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .manual-break::after {
            content: "::: QUEBRA DE PÁGINA (Arraste para mover) :::";
            font-size: 9px;
            font-weight: 900;
            color: #ef4444;
            letter-spacing: 1px;
        }

        .manual-spacer {
            background: repeating-linear-gradient(45deg, #f8fafc, #f8fafc 10px, #e2e8f0 10px, #e2e8f0 20px);
            border: 1px dashed #cbd5e1;
            resize: vertical;
            overflow: hidden;
            min-height: 20px;
            margin: 5px 0;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .manual-spacer::before {
            content: "::: ESPAÇADOR (Arraste) :::";
            font-size: 9px;
            font-weight: 700;
            color: #94a3b8;
            pointer-events: none;
        }

        .add-layout-btn {
            display: none;
            background-color: #3b82f6;
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 4px 10px;
            border-radius: 4px;
            margin: 4px auto;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            width: fit-content;
            opacity: 0.9;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .add-layout-btn:hover { opacity: 1; transform: scale(1.02); }

        .layout-mode-active .add-layout-btn { display: flex; }
        .layout-mode-active .printable-area { border: 2px solid #e2e8f0; }

        .delete-item-btn {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            background: #ef4444;
            color: white;
            border-radius: 4px;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 20;
        }
        
        .layout-mode-active .manual-break .delete-item-btn,
        .layout-mode-active .manual-spacer .delete-item-btn {
            display: flex;
        }

        .item-anexo-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        /* BARRA DE FORMATAÇÃO (EDITADA) */
        .editor-tools {
            display: flex;
            gap: 2px;
            background: #f1f5f9;
            padding: 4px;
            border: 1px solid #cbd5e1;
            width: fit-content;
            margin-bottom: 2px;
        }

        .tool-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 900;
            cursor: pointer;
            border: 1px solid transparent;
            background: white;
            color: #475569;
            transition: all 0.1s;
        }

        .tool-btn:hover {
            background-color: #e2e8f0;
            border-color: #94a3b8;
            color: #000;
        }

        .tool-btn:active {
            background-color: #cbd5e1;
        }

        .color-picker-wrapper {
            display: flex;
            align-items: center;
            position: relative;
            cursor: pointer;
            overflow: hidden;
        }

        .color-picker-input {
            position: absolute;
            width: 200%;
            height: 200%;
            left: -50%;
            top: -50%;
            cursor: pointer;
            opacity: 0;
        }

        @media print {
            @page { margin: 0; size: A4 portrait; }
            body { background: white !important; padding: 0 !important; }
            .printable-area { margin: 0 !important; width: 100% !important; border: none !important; box-shadow: none !important; }
            .no-print, .layout-toolbar, .add-layout-btn, .delete-item-btn, .editor-tools { display: none !important; }
            .pdf-page-break { display: block; page-break-after: always; height: 0; }
            .content-padding { padding: 10mm !important; }
            
            textarea, input { border: none !important; }
            .resizable-wrapper { resize: none; }
            
            /* CSS Nativo para Impressão */
            .manual-break {
                border: none !important; 
                background: none !important; 
                height: 0 !important; 
                margin: 0 !important;
                padding: 0 !important;
                page-break-after: always !important; 
                display: block !important;
                visibility: hidden !important;
            }
            .manual-break::after { content: none !important; display: none !important; }
            
            .manual-spacer { 
                border: none !important; 
                background: none !important; 
            }
            .manual-spacer::before { content: none !important; display: none !important; }
            
            .printable-area { border: none !important; }
            .rich-editor { border: none !important; padding: 0 !important; }
        }
    </style>
</head>
<body class="">

    <div id="printable-dashboard" class="printable-area">
        
        <div class="content-padding p-4">
            <div class="text-center mb-3">
                <h2 id="display-main-title" class="text-lg font-black uppercase text-red-800 tracking-tight">AUDITORIA INTERNA / LAUDO TÉCNICO</h2>
            </div>

            <div class="card-top-main flex justify-between items-center p-3">
                <div class="flex items-center gap-3">
                    <div class="bg-white p-1.5 shadow-sm">
                        <i data-lucide="file-text" class="text-[#7f1d1d] w-5 h-5"></i>
                    </div>
                    <div>
                        <h1 class="text-sm font-black uppercase leading-none">Compliance & Auditoria Interna</h1>
                        <p class="text-[7px] font-bold uppercase mt-1">auditoriainterna@diamantesl.com</p>
                    </div>
                </div>
                <div class="text-right flex flex-col items-end">
                    <div id="display-fr-ref" class="bg-red-950 px-2 py-0.5 text-[8px] font-black border border-black uppercase inline-block leading-none">FR-AUD-289</div>
                    <p id="display-date-ref" class="text-[7px] font-bold uppercase mt-1 leading-none">Ref: --/--/----</p>
                    <button onclick="clearData()" class="no-print mt-1.5 text-[8px] font-black bg-white text-[#7f1d1d] px-1.5 py-0.5 uppercase hover:bg-red-50 flex items-center gap-1 shadow-sm border border-[#7f1d1d]">
                        <i data-lucide="eraser" class="w-2.5 h-2.5"></i> Limpar Tudo
                    </button>
                </div>
            </div>

            <div class="mt-4">
                <table class="header-table-grid w-full">
                    <tr>
                        <td class="cell-label w-28">Área Auditada:</td>
                        <td class="cell-value" colspan="3"><input type="text" value="" id="input-area" placeholder="..."></td>
                        <td class="cell-label w-24">Laudo Nº:</td>
                        <td class="cell-value"><input type="text" value="" id="input-rel" class="text-center" placeholder="000"></td>
                    </tr>
                    <tr>
                        <td class="cell-label">Objetivo / Escopo:</td>
                        <td class="cell-value" colspan="5">
                            <textarea class="dynamic-textarea" id="input-obj" rows="1" placeholder="Descreva o objetivo da auditoria..."></textarea>
                        </td>
                    </tr>
                    <tr>
                        <td class="cell-label">Norma(s) de Ref:</td>
                        <td class="cell-value" colspan="3"><input type="text" value="" id="input-normas" placeholder="..."></td>
                        <td class="cell-label">MD Recomendada:</td>
                        <td class="cell-value">
                            <select id="input-md" class="w-full bg-transparent font-bold text-[9px] uppercase">
                                <option value="Não">Não</option>
                                <option value="Sim">Sim</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td class="cell-label">Valor Agregado:</td>
                        <td class="cell-value" colspan="1">
                            <div class="flex items-center"><span>R$&nbsp;</span><input type="text" id="input-agreg" value="" placeholder="0,00"></div>
                        </td>
                        <td class="cell-label w-20">Notific.:</td>
                        <td class="cell-value w-16"><input type="text" value="" id="input-notific" class="text-center" placeholder="0"></td>
                        <td class="cell-label w-16">NC's:</td>
                        <td class="cell-value w-16"><input type="text" value="" id="input-ncs" class="text-center" placeholder="0"></td>
                    </tr>
                    <tr>
                        <td class="cell-label">Gestor / Diretor:</td>
                        <td class="cell-value" colspan="5"><input type="text" value="" id="input-gestor" placeholder="Nomes dos responsáveis..."></td>
                    </tr>
                </table>
            </div>

            <div class="mt-4 border border-black p-3 avoid-break bg-white">
                <div class="section-header-wrapper flex items-center gap-2">
                    <span class="section-header"><i data-lucide="grid" class="w-3 h-3 inline"></i> 1. MATRIZ DE RISCO DA AUDITORIA</span>
                </div>
                <div id="risk-matrix-container"></div>

                <div class="mt-3 bg-slate-50 border border-black p-3 text-center">
                    <h4 class="text-[8px] font-black uppercase text-slate-400 mb-1">Resultado da Análise de Risco</h4>
                    <div id="risk-result">
                        <p class="text-[9px] font-bold text-slate-400 mb-0.5 uppercase italic">Selecione um quadrante na matriz acima</p>
                    </div>
                </div>
            </div>
            
            <div id="extra-break-1"></div>
        </div>

        <div class="content-padding p-4 pt-0">
            <section class="mb-6 avoid-break">
                <div class="section-header-wrapper flex items-center gap-2">
                    <span class="section-header"><i data-lucide="info" class="w-3 h-3 inline"></i> 2. DESCRIÇÃO PRELIMINAR E CONTEXTO</span>
                </div>
                <div class="mb-2">
                    <!-- Ferramentas de Edição -->
                    <div class="no-print editor-tools items-center">
                        <button onmousedown="event.preventDefault(); formatDoc('bold')" class="tool-btn" title="Negrito">B</button>
                        <div class="flex items-center border-l border-gray-300 ml-1 pl-1 gap-1">
                            <div class="color-picker-wrapper tool-btn" title="Escolher Cor">
                                <i data-lucide="palette" class="w-3 h-3"></i>
                                <input type="color" class="color-picker-input">
                            </div>
                            <button onmousedown="event.preventDefault(); let val = this.previousElementSibling.querySelector('input').value; formatDoc('foreColor', val)" class="tool-btn text-[9px] font-black text-green-700 w-auto px-1.5" title="Confirmar Cor">
                                OK
                            </button>
                        </div>
                    </div>
                    <div id="input-preliminar" contenteditable="true" class="rich-editor" placeholder="Cenário inicial, observações e contexto da auditoria..." oninput="savePreliminarContent(this.innerHTML)"></div>
                </div>
                
                <div id="preliminar-images" class="flex flex-wrap gap-2 mb-2"></div>
                
                <button onclick="addImage('preliminar')" class="no-print mt-1.5 text-[8px] font-black text-red-700 flex items-center gap-1 uppercase tracking-tighter">
                    <i data-lucide="plus" class="w-3 h-3"></i> Adicionar Anexo ao Contexto
                </button>
            </section>
            
            <div id="extra-break-2"></div>

            <section>
                <div class="section-header-wrapper flex items-center gap-2">
                    <span class="section-header"><i data-lucide="alert-triangle" class="w-3 h-3 inline"></i> 3. APONTAMENTOS E NÃO CONFORMIDADES</span>
                </div>
                <div id="findings-list" class="flex flex-col gap-4"></div>
                
                <div class="mt-4 text-center no-print">
                   <button onclick="addFinding()" class="bg-red-700 text-white px-3 py-1 font-bold text-xs rounded uppercase hover:bg-red-800">+ Novo Apontamento</button>
                </div>
            </section>
        </div>

        <div class="content-padding p-4 pt-0">
            <section class="avoid-break">
                <div class="section-header-wrapper flex items-center gap-2">
                    <span class="section-header"><i data-lucide="check-circle" class="w-3 h-3 inline"></i> 4. PARECER TÉCNICO E RECOMENDAÇÕES FINAIS</span>
                </div>
                <div id="final-opinions" class="flex flex-col gap-2 border border-black p-3 bg-slate-50/50"></div>
                <button onclick="addOpinion()" class="no-print mt-1 text-[8px] font-black text-red-700 flex items-center gap-1 uppercase tracking-tighter">
                    <i data-lucide="plus" class="w-3 h-3"></i> Adicionar Tópico ao Parecer
                </button>

                <div class="mt-12 flex flex-col items-center text-center">
                    <div class="w-72 border-t border-black pt-1.5">
                        <span class="text-[11px] font-black uppercase block">Francisco Tiago da Silva Ferreira</span>
                        <span class="text-[8px] text-gray-600 font-bold uppercase block leading-tight mt-0.5">Auditor Interno Sênior / Especialista em Auditoria Interna</span>
                        <span class="text-[8px] text-red-800 font-bold lowercase block underline">auditoriainterna@diamantesl.com</span>
                        <div class="mt-3 text-[7px] text-gray-300 font-bold uppercase">Assinado Eletronicamente — Criptografia SHA-256</div>
                    </div>
                </div>
            </section>

            <footer class="p-4 text-center border-t border-gray-100 mt-10">
                <p class="text-[7px] text-gray-300 font-black uppercase tracking-[0.4em]">Laudo Gerado Via Sistema Integrado de Auditoria e Riscos</p>
            </footer>
        </div>
    </div>

    <!-- BOTÕES DISCRETOS -->
    <div class="layout-toolbar">
        <button onclick="toggleLayoutMode()" id="btn-toggle-layout" class="discreet-btn">
            <i data-lucide="settings-2" class="w-4 h-4"></i> <span id="txt-layout-mode">Ajustar Layout</span>
        </button>
        <button onclick="generatePDF()" class="discreet-btn btn-pdf">
            <i data-lucide="file-down" class="w-4 h-4"></i> PDF
        </button>
    </div>

    <div id="toast" class="hidden fixed top-4 right-4 bg-slate-900 text-white px-5 py-2.5 shadow-2xl z-50 flex items-center gap-2">
        <i data-lucide="check" class="w-4 h-4 text-green-400"></i>
        <span id="toast-message" class="font-bold text-xs uppercase"></span>
    </div>

    <script>
        lucide.createIcons();

        let isLayoutMode = false;
        let selectedRiskCoord = { r: -1, c: -1 }; 
        let currentSequence = 289; 

        const generateId = () => Date.now() + Math.random().toString(36).substr(2, 9);

        let preliminarImages = [];
        let preliminarContent = "";
        let findings = []; 
        let opinions = []; 
        let extraBreaks = { afterMatrix: [], afterContext: [] };

        // Função de formatação robusta que mantém a seleção
        function formatDoc(cmd, value = null) {
            document.execCommand(cmd, false, value);
        }

        function savePreliminarContent(content) {
            preliminarContent = content;
        }

        function updateAutoRefs() {
            const today = new Date();
            const dateStr = today.toLocaleDateString('pt-BR');
            document.getElementById('display-date-ref').innerText = `Ref: ${dateStr}`;
            document.getElementById('display-fr-ref').innerText = `FR-AUD-${currentSequence}`;
        }

        function toggleLayoutMode() {
            isLayoutMode = !isLayoutMode;
            document.body.classList.toggle('layout-mode-active', isLayoutMode);
            const btn = document.getElementById('btn-toggle-layout');
            const txt = document.getElementById('txt-layout-mode');
            if (isLayoutMode) {
                btn.classList.add('btn-active');
                txt.innerText = "Fechar Ajuste";
                showToast("MODO AJUSTE ATIVO");
            } else {
                btn.classList.remove('btn-active');
                txt.innerText = "Ajustar Layout";
            }
            renderExtraBreaks(); renderFindings(); renderOpinions();
        }

        function initAutoResize() {
            document.querySelectorAll('.dynamic-textarea').forEach(textarea => {
                const resize = () => { textarea.style.height = 'auto'; textarea.style.height = (textarea.scrollHeight) + 'px'; };
                textarea.addEventListener('input', resize); resize();
            });
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-message').innerText = msg;
            t.classList.remove('hidden'); setTimeout(() => t.classList.add('hidden'), 3000);
        }

        function clearData() {
            if(!confirm('Deseja iniciar um novo laudo? (A sequência será incrementada)')) return;
            currentSequence++;
            findings = []; opinions = []; extraBreaks = { afterMatrix: [], afterContext: [] }; preliminarImages = []; selectedRiskCoord = { r: -1, c: -1 }; preliminarContent = "";
            document.querySelectorAll('input[type="text"]').forEach(i => i.value = '');
            document.querySelectorAll('textarea').forEach(i => i.value = '');
            document.getElementById('input-preliminar').innerHTML = '';
            document.getElementById('risk-result').innerHTML = '<p class="text-[9px] font-bold text-slate-400 mb-0.5 uppercase italic">Selecione um quadrante na matriz acima</p>';
            updateAutoRefs(); renderMatrix(); renderPrelimImages(); renderFindings(); renderOpinions(); renderExtraBreaks();
            showToast("NOVO LAUDO INICIADO!");
        }

        function addFinding() {
            findings.push({ id: generateId(), type: 'finding', proc: '', evid: [{ text: '', imgs: [] }], nc: [{ text: '', imgs: [] }], acao: '', resp: '', imgs: [] });
            renderFindings();
        }

        function getLayoutButtonsHTML(target, index) {
            return `
                <div class="no-print flex justify-center gap-2 my-2">
                    <button onclick="addLayoutItem('${target}', ${index}, 'break')" class="add-layout-btn">
                        <i data-lucide="scissors" class="w-3 h-3"></i> + Quebra
                    </button>
                    <button onclick="addLayoutItem('${target}', ${index}, 'spacer')" class="add-layout-btn">
                        <i data-lucide="maximize-2" class="w-3 h-3"></i> + Espaçador
                    </button>
                </div>
            `;
        }

        function getLayoutItemHTML(item, target) {
            if (item.type === 'break') {
                return `
                    <div class="draggable-item manual-break" data-id="${item.id}">
                    </div>
                `;
            } else if (item.type === 'spacer') {
                return `
                    <div class="draggable-item manual-spacer" data-id="${item.id}" style="height: ${item.height}px;">
                        <button onclick="removeLayoutItem('${target}', '${item.id}')" class="delete-item-btn">
                            <i data-lucide="trash-2" class="w-3 h-3"></i>
                        </button>
                    </div>
                `;
            }
            return '';
        }

        function addLayoutItem(target, index, itemType) {
            const newItem = { id: generateId(), type: itemType };
            if (itemType === 'spacer') newItem.height = 30;
            if (target === 'findings') findings.splice(index + 1, 0, newItem);
            else if (target === 'opinions') opinions.splice(index + 1, 0, newItem);
            else if (target === 'extra1') extraBreaks.afterMatrix.splice(index + 1, 0, newItem);
            else if (target === 'extra2') extraBreaks.afterContext.splice(index + 1, 0, newItem);
            renderExtraBreaks(); renderFindings(); renderOpinions();
        }

        function removeLayoutItem(target, id) {
            if (target === 'findings') findings = findings.filter(i => i.id !== id);
            else if (target === 'opinions') opinions = opinions.filter(i => i.id !== id);
            else if (target === 'extra1') extraBreaks.afterMatrix = extraBreaks.afterMatrix.filter(i => i.id !== id);
            else if (target === 'extra2') extraBreaks.afterContext = extraBreaks.afterContext.filter(i => i.id !== id);
            renderExtraBreaks(); renderFindings(); renderOpinions();
        }

        function addImage(target, findingId = null, listType = null, itemIndex = null) {
            const input = document.createElement('input'); input.type = 'file'; input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0]; const reader = new FileReader();
                reader.onload = () => {
                    if (target === 'preliminar') { preliminarImages.push(reader.result); renderPrelimImages(); }
                    else if (target === 'finding-item') {
                        const f = findings.find(x => x.id === findingId);
                        if (f && f[listType][itemIndex]) { f[listType][itemIndex].imgs.push(reader.result); renderFindings(); }
                    }
                };
                reader.readAsDataURL(file);
            };
            input.click();
        }

        function renderExtraBreaks() {
            const c1 = document.getElementById('extra-break-1');
            let html1 = isLayoutMode ? getLayoutButtonsHTML('extra1', -1) : ''; 
            extraBreaks.afterMatrix.forEach(item => html1 += getLayoutItemHTML(item, 'extra1'));
            c1.innerHTML = html1;

            const c2 = document.getElementById('extra-break-2');
            let html2 = isLayoutMode ? getLayoutButtonsHTML('extra2', -1) : ''; 
            extraBreaks.afterContext.forEach(item => html2 += getLayoutItemHTML(item, 'extra2'));
            c2.innerHTML = html2;

            lucide.createIcons();
        }

        // Helper para gerar o HTML do toolbar rico com botão OK de confirmação
        function getRichToolbarHTML() {
            return `
                <div class="no-print editor-tools items-center">
                    <button onmousedown="event.preventDefault(); formatDoc('bold')" class="tool-btn" title="Negrito">B</button>
                    <div class="flex items-center border-l border-gray-300 ml-1 pl-1 gap-1">
                        <div class="color-picker-wrapper tool-btn" title="Escolher Cor">
                            <i data-lucide="palette" class="w-3 h-3"></i>
                            <input type="color" class="color-picker-input">
                        </div>
                        <button onmousedown="event.preventDefault(); let val = this.previousElementSibling.querySelector('input').value; formatDoc('foreColor', val)" class="tool-btn text-[9px] font-black text-green-700 w-auto px-1.5" title="Confirmar Cor">
                            OK
                        </button>
                    </div>
                </div>
            `;
        }

        function renderFindings() {
            const container = document.getElementById('findings-list'); let html = '';
            findings.forEach((f, i) => {
                if (f.type === 'break' || f.type === 'spacer') {
                    html += getLayoutItemHTML(f, 'findings');
                } else {
                    html += `
                    <div class="draggable-item" data-id="${f.id}">
                        <div class="avoid-break border border-black bg-white overflow-hidden relative group">
                            <div class="bg-slate-900 p-1.5 border-b border-black flex justify-between items-center">
                                <span class="text-[9px] font-black uppercase text-white tracking-widest px-1">Apontamento</span>
                                <button onclick="removeLayoutItem('findings', '${f.id}')" class="no-print text-red-400"><i data-lucide="x" class="w-3.5 h-3.5"></i></button>
                            </div>
                            <div class="p-3 flex flex-col gap-3">
                                <input type="text" class="border border-black p-1 bg-slate-50 font-bold text-[9px] uppercase" value="${f.proc}" placeholder="OBJETO DO EXAME..." onchange="findings[${i}].proc = this.value">
                                <div class="border border-black p-2 bg-white">
                                    <h4 class="text-[8px] font-black text-red-900 uppercase mb-1.5 flex items-center gap-1"><i data-lucide="paperclip" class="w-2.5 h-2.5"></i> Evidências</h4>
                                    ${f.evid.map((e, ei) => `
                                        <div class="list-item-separator">
                                            ${getRichToolbarHTML()}
                                            <div class="flex gap-2 items-start">
                                                <span class="text-[9px] font-bold mt-0.5 text-red-800">[${ei+1}]</span>
                                                <div contenteditable="true" class="rich-editor flex-1" placeholder="Descreva o fato..." oninput="findings[${i}].evid[${ei}].text = this.innerHTML">${e.text}</div>
                                                <button onclick="findings[${i}].evid.splice(${ei}, 1); renderFindings()" class="no-print text-red-300"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                                            </div>
                                            <div class="item-anexo-gallery">${e.imgs.map((img, imi) => `<div class="resizable-wrapper" style="width: 80px; height: 80px;"><img src="${img}"><button onclick="findings[${i}].evid[${ei}].imgs.splice(${imi}, 1); renderFindings()" class="no-print absolute top-0 right-0 bg-red-700 text-white p-0.5"><i data-lucide="trash-2" class="w-2 h-2"></i></button></div>`).join('')}</div>
                                            <button onclick="addImage('finding-item', '${f.id}', 'evid', ${ei})" class="no-print mt-1 text-[7px] font-black text-red-700 uppercase opacity-60">+ Anexo</button>
                                        </div>`).join('')}
                                    <button onclick="findings[${i}].evid.push({text: '', imgs: []}); renderFindings()" class="no-print text-[7px] font-black text-red-700 uppercase mt-1">+ Fato</button>
                                </div>
                                <div class="border border-black p-2 bg-white">
                                    <h4 class="text-[8px] font-black text-red-900 uppercase mb-1.5 flex items-center gap-1"><i data-lucide="alert-triangle" class="w-2.5 h-2.5"></i> Não Conformidades</h4>
                                    ${f.nc.map((n, ni) => `
                                        <div class="list-item-separator">
                                            ${getRichToolbarHTML()}
                                            <div class="flex gap-2 items-start">
                                                <span class="text-[9px] font-bold mt-0.5 text-red-800">[${ni+1}]</span>
                                                <div contenteditable="true" class="rich-editor flex-1" placeholder="Descreva o desvio..." oninput="findings[${i}].nc[${ni}].text = this.innerHTML">${n.text}</div>
                                                <button onclick="findings[${i}].nc.splice(${ni}, 1); renderFindings()" class="no-print text-red-300"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                                            </div>
                                            <div class="item-anexo-gallery">${n.imgs.map((img, imi) => `<div class="resizable-wrapper" style="width: 80px; height: 80px;"><img src="${img}"><button onclick="findings[${i}].nc[${ni}].imgs.splice(${imi}, 1); renderFindings()" class="no-print absolute top-0 right-0 bg-red-700 text-white p-0.5"><i data-lucide="trash-2" class="w-2 h-2"></i></button></div>`).join('')}</div>
                                            <button onclick="addImage('finding-item', '${f.id}', 'nc', ${ni})" class="no-print mt-1 text-[7px] font-black text-red-700 uppercase opacity-60">+ Anexo</button>
                                        </div>`).join('')}
                                    <button onclick="findings[${i}].nc.push({text: '', imgs: []}); renderFindings()" class="no-print text-[7px] font-black text-red-700 uppercase mt-1">+ Desvio</button>
                                </div>
                                <div class="grid grid-cols-2 gap-2 border-t border-black pt-2">
                                    <input type="text" value="${f.acao}" onchange="findings[${i}].acao = this.value" placeholder="PLANO AÇÃO" class="border border-black p-1 text-[8px] bg-green-50/20">
                                    <input type="text" value="${f.resp}" onchange="findings[${i}].resp = this.value" placeholder="RESPONSÁVEL" class="border border-black p-1 text-[8px] bg-green-50/20">
                                </div>
                            </div>
                        </div>
                    </div>`;
                }
                if (isLayoutMode) html += getLayoutButtonsHTML('findings', i);
            });
            container.innerHTML = html; lucide.createIcons(); initAutoResize();
        }

        function renderOpinions() {
            const container = document.getElementById('final-opinions'); let html = '';
            opinions.forEach((o, i) => {
                if (o.type === 'break' || o.type === 'spacer') {
                    html += getLayoutItemHTML(o, 'opinions');
                } else {
                    html += `
                    <div class="draggable-item" data-id="${o.id}">
                        <div class="flex gap-2 border-b border-gray-100 pb-1.5 mb-1.5 last:border-0 items-start list-item-separator">
                            <span class="text-[9px] font-black text-slate-400 mt-1">#</span>
                            <textarea class="dynamic-textarea flex-1" onchange="opinions[${i}].value = this.value" placeholder="Parecer...">${o.value}</textarea>
                            <button onclick="removeLayoutItem('opinions', '${o.id}')" class="no-print text-red-400 mt-1"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                        </div>
                    </div>`;
                }
                if (isLayoutMode) html += getLayoutButtonsHTML('opinions', i);
            });
            container.innerHTML = html; lucide.createIcons(); initAutoResize();
        }

        function addOpinion() { opinions.push({ id: generateId(), type: 'text', value: '' }); renderOpinions(); }

        function renderMatrix() {
            const impactLabels = ['Mínimo', 'Leve', 'Moderado', 'Grave', 'Gravíssimo'];
            const probLabels = ['(FC) 1 M. Alto', '(FC) 0.8 Alto', '(FC) 0.6 Médio', '(FC) 0.4 Baixo', '(FC) 0.2 M. Baixo'];
            const levels = [['MODERADO', 'ELEVADO', 'EXTREMO', 'EXTREMO', 'EXTREMO'],['MODERADO', 'ELEVADO', 'ELEVADO', 'EXTREMO', 'EXTREMO'],['BAIXO', 'MODERADO', 'ELEVADO', 'EXTREMO', 'EXTREMO'],['BAIXO', 'BAIXO', 'MODERADO', 'ELEVADO', 'EXTREMO'],['BAIXO', 'BAIXO', 'BAIXO', 'MODERADO', 'ELEVADO']];
            const colors = [['bg-emerald-600', 'bg-yellow-400', 'bg-red-600', 'bg-red-600', 'bg-red-700'],['bg-emerald-600', 'bg-yellow-400', 'bg-yellow-400', 'bg-red-600', 'bg-red-700'],['bg-emerald-500', 'bg-emerald-600', 'bg-yellow-400', 'bg-red-600', 'bg-red-600'],['bg-emerald-500', 'bg-emerald-500', 'bg-emerald-600', 'bg-yellow-400', 'bg-red-600'],['bg-emerald-500', 'bg-emerald-500', 'bg-emerald-500', 'bg-emerald-600', 'bg-yellow-400']];
            const values = [['10%','30%','50%','75%','95%'],['8%','24%','40%','60%','76%'],['6%','18%','30%','45%','57%'],['4%','12%','20%','30%','38%'],['2%','6%','10%','15%','19%']];
            let html = `<table class="w-full border-collapse border border-gray-300"><thead><tr><th class="border border-gray-300"></th>`;
            impactLabels.forEach(l => html += `<th class="border border-gray-300 bg-gray-50 p-1 text-[7px] font-black uppercase">${l}</th>`);
            html += `</tr></thead><tbody>`;
            probLabels.forEach((p, r) => {
                html += `<tr><td class="border border-gray-300 bg-gray-50 p-1 text-[7px] font-bold text-center leading-none">${p}</td>`;
                levels[r].forEach((lvl, c) => {
                    const color = colors[r][c]; const isSelected = selectedRiskCoord.r === r && selectedRiskCoord.c === c;
                    html += `<td class="border border-gray-300 p-0.5"><button onclick="selectRisk(${r}, ${c}, '${values[r][c]}', '${lvl}', '${impactLabels[c]}', '${p}')" class="w-full h-9 flex flex-col justify-center items-center ${color} transition-all ${isSelected ? 'risk-btn-selected' : 'hover:opacity-80'}"><span class="text-[6px] font-black ${color.includes('yellow') ? 'text-gray-800' : 'text-white'} leading-none">${lvl}</span><span class="text-[8px] font-black ${color.includes('yellow') ? 'text-gray-900' : 'text-white'} leading-none">${values[r][c]}</span></button></td>`;
                }); html += `</tr>`;
            }); html += `</tbody></table>`;
            document.getElementById('risk-matrix-container').innerHTML = html;
        }

        function selectRisk(r, c, val, lvl, imp, prob) {
            selectedRiskCoord = { r, c }; renderMatrix();
            document.getElementById('risk-result').innerHTML = `<p class="text-[9px] font-bold text-slate-700 mb-0.5 uppercase">IMPACTO: ${imp.toUpperCase()} | PROBABILIDADE: ${prob.toUpperCase()}</p><p class="text-[12px] font-black uppercase text-red-900 leading-none">VALOR: ${val} — ${lvl}</p>`;
        }

        function renderPrelimImages() {
            const container = document.getElementById('preliminar-images');
            container.innerHTML = preliminarImages.map((img, i) => `<div class="resizable-wrapper bg-white shadow-sm" style="width: 32%; height: 200px;"><img src="${img}"><button onclick="preliminarImages.splice(${i}, 1); renderPrelimImages()" class="no-print absolute top-0 right-0 bg-red-700 text-white p-1 z-20"><i data-lucide="trash-2" class="w-3 h-3"></i></button></div>`).join('');
            lucide.createIcons();
        }

        async function generatePDF() {
            if (isLayoutMode) toggleLayoutMode();
            const originalElement = document.getElementById('printable-dashboard'); 
            const clone = originalElement.cloneNode(true);
            
            // 1. Remover elementos desnecessários
            clone.querySelectorAll('.no-print, .editor-tools, .add-layout-btn, .delete-item-btn').forEach(el => el.remove());
            
            // 2. Limpar agressivamente os estilos de quebras e espaçadores no clone
            clone.querySelectorAll('.manual-break').forEach(el => {
                // Remove a classe para garantir que o CSS não a encontre
                el.className = ''; 
                // Define estilos de quebra limpos e invisíveis
                el.style.cssText = "border: 0 !important; border-top: 0 !important; margin: 0 !important; padding: 0 !important; height: 0 !important; background: none !important; page-break-after: always !important; display: block !important; outline: none !important; box-shadow: none !important; visibility: hidden !important;";
                el.innerHTML = ''; 
            });

            clone.querySelectorAll('.manual-spacer').forEach(el => {
                el.style.cssText = "border: 0 !important; border-top: 0 !important; margin: 0 !important; padding: 0 !important; background: none !important; outline: none !important; box-shadow: none !important; overflow: hidden !important;";
                el.innerHTML = ''; 
            });
            
            // 3. Converter entradas em texto estático
            clone.querySelectorAll('textarea').forEach((ta, idx) => { 
                const originalTa = originalElement.querySelectorAll('textarea')[idx]; 
                const div = document.createElement('div'); 
                div.className = 'pdf-static-text'; 
                div.textContent = originalTa.value; 
                ta.parentNode.replaceChild(div, ta); 
            });
            
            clone.querySelectorAll('.rich-editor').forEach((re, idx) => {
                const originalRe = originalElement.querySelectorAll('.rich-editor')[idx];
                const div = document.createElement('div');
                div.className = 'pdf-static-text';
                div.innerHTML = originalRe.innerHTML || "";
                re.parentNode.replaceChild(div, re);
            });

            clone.querySelectorAll('input[type="text"]').forEach((inp, idx) => { 
                const originalInp = originalElement.querySelectorAll('input[type="text"]')[idx]; 
                const span = document.createElement('span'); 
                span.className = 'pdf-static-text'; 
                span.textContent = originalInp.value; 
                inp.parentNode.replaceChild(span, inp); 
            });

            clone.querySelectorAll('select').forEach((sel, idx) => { 
                const originalSel = originalElement.querySelectorAll('select')[idx]; 
                const span = document.createElement('span'); 
                span.className = 'pdf-static-text text-center block w-full uppercase'; 
                span.textContent = originalSel.value; 
                sel.parentNode.replaceChild(span, sel); 
            });
            
            const opt = { 
                margin: [10, 10, 30, 10], 
                filename: `Laudo_Auditoria_${document.getElementById('input-rel').value || 'S_N'}.pdf`, 
                image: { type: 'jpeg', quality: 0.98 }, 
                html2canvas: { 
                    scale: 2, 
                    useCORS: true, 
                    letterRendering: true, 
                    scrollY: 0,
                    logging: false 
                }, 
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }, 
                pagebreak: { mode: ['css', 'legacy'], avoid: ['.avoid-break', '.list-item-separator', '.section-header-wrapper'] } 
            };

            showToast("GERANDO PDF...");
            try { 
                await html2pdf().set(opt).from(clone).save(); 
                showToast("SUCESSO!"); 
            } catch (error) { 
                showToast("ERRO!"); 
                console.error(error);
            }
        }

        window.onload = () => { 
            updateAutoRefs(); 
            renderMatrix(); 
            renderExtraBreaks(); 
            renderPrelimImages(); 
            renderFindings(); 
            renderOpinions(); 
            initAutoResize(); 
        };
    </script>
</body>
</html>
