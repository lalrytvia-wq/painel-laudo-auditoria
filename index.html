<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Auditoria Interna - Diamante Lingerie</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');

        body { 
            font-family: 'Inter', 'Segoe UI', sans-serif;
            background-color: #f1f5f9;
            color: #1e293b;
        }

        * { border-radius: 0 !important; }

        /* Regras de Impressão e PDF */
        .avoid-break { 
            page-break-inside: avoid !important; 
            break-inside: avoid !important;
        }

        .pdf-page-break {
            display: none;
        }

        .printable-area {
            max-width: 1000px;
            margin: 1.5rem auto;
            background: #fff;
            border: 1px solid #e2e8f0;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        .card-top-main {
            background-color: #b91c1c !important;
            color: #ffffff !important;
            border-bottom: 2px solid #000;
        }

        .header-table-grid {
            border: 1.5px solid #000000 !important;
            width: 100%;
            border-collapse: collapse;
        }

        .cell-label {
            background-color: #7f1d1d !important; 
            color: #ffffff !important;
            font-weight: 700;
            font-size: 8.5px;
            text-transform: uppercase;
            padding: 6px 10px;
            border: 1px solid #000;
        }

        .cell-value {
            background-color: #fff1f2 !important; 
            color: #000000 !important;
            font-weight: 700;
            font-size: 10px;
            padding: 6px 10px;
            border: 1px solid #000;
        }

        .section-header {
            font-size: 11px;
            font-weight: 900;
            text-transform: uppercase;
            color: #7f1d1d;
            border-bottom: 2px solid #7f1d1d;
            padding-bottom: 4px;
            margin-bottom: 12px;
        }

        @media print {
            @page { margin: 0; size: A4 portrait; }
            body { background: white !important; padding: 0 !important; }
            .printable-area { margin: 0 !important; width: 100% !important; border: none !important; box-shadow: none !important; }
            .no-print { display: none !important; }
            .pdf-page-break { display: block; page-break-after: always; height: 0; }
            .content-padding { padding: 15mm !important; }
        }

        input, textarea {
            background: transparent;
            width: 100%;
            outline: none;
            font-weight: 700;
        }

        textarea { resize: none; }
    </style>
</head>
<body>

    <div id="printable-dashboard" class="printable-area">
        
        <!-- PÁGINA 1: IDENTIFICAÇÃO E RISCO -->
        <div class="content-padding p-6">
            <div class="text-center mb-4">
                <h2 id="display-main-title" class="text-xl font-black uppercase text-red-800 tracking-wider">LAUDO TÉCNICO DE AUDITORIA</h2>
            </div>

            <div class="card-top-main flex justify-between items-center p-4">
                <div class="flex items-center gap-3">
                    <div class="bg-white p-2">
                        <i data-lucide="file-text" class="text-red-700 w-6 h-6"></i>
                    </div>
                    <div>
                        <h1 class="text-base font-black uppercase leading-none">Compliance & Auditoria Interna</h1>
                        <p class="text-[8px] font-bold uppercase mt-1">Laudo de Auditoria Interna | auditoriainterna@diamantesl.com</p>
                    </div>
                </div>
                <div class="text-right">
                    <div class="bg-red-950 px-2 py-0.5 text-[9px] font-black border border-black uppercase inline-block">FR-AUD-001</div>
                    <p class="text-[8px] font-bold uppercase mt-1">Ref: 09/02/2026</p>
                    <button onclick="generatePDF()" class="no-print mt-2 bg-white text-red-800 px-3 py-1 font-black text-[9px] uppercase shadow hover:bg-red-50 flex items-center gap-1">
                        <i data-lucide="file-down" class="w-3 h-3"></i> Gerar PDF Oficial
                    </button>
                </div>
            </div>

            <!-- Tabela de Dados -->
            <div class="mt-6">
                <table class="header-table-grid w-full">
                    <tr>
                        <td class="cell-label w-32">Área Auditada:</td>
                        <td class="cell-value" colspan="3"><input type="text" value="Comercial" id="input-area"></td>
                        <td class="cell-label w-24">Laudo Nº:</td>
                        <td class="cell-value"><input type="text" value="289" id="input-rel" class="text-center"></td>
                    </tr>
                    <tr>
                        <td class="cell-label">Objetivo / Escopo:</td>
                        <td class="cell-value" colspan="5"><input type="text" value="Auditar a conformidade fiscal e operacional das transações com descontos superiores a 30% realizadas em 2025." id="input-obj"></td>
                    </tr>
                    <tr>
                        <td class="cell-label">Norma(s) de Ref:</td>
                        <td class="cell-value" colspan="3"><input type="text" value="Pops e Politicas Internas" id="input-normas"></td>
                        <td class="cell-label">MD Recomendada:</td>
                        <td class="cell-value">
                            <select id="input-md" class="w-full bg-transparent font-bold text-[10px]">
                                <option value="Não">Não</option>
                                <option value="Sim">Sim</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td class="cell-label">Valor Agregado:</td>
                        <td class="cell-value" colspan="1">
                            <div class="flex"><span>R$&nbsp;</span><input type="text" id="input-agreg" value=""></div>
                        </td>
                        <td class="cell-label w-24">Notific.:</td>
                        <td class="cell-value"><input type="text" value="1" id="input-notific" class="text-center"></td>
                        <td class="cell-label w-16">NC's:</td>
                        <td class="cell-value"><input type="text" value="1" id="input-ncs" class="text-center"></td>
                    </tr>
                    <tr>
                        <td class="cell-label">Gestor / Diretor:</td>
                        <td class="cell-value" colspan="5"><input type="text" value="Aline Roberta / Daniele Sobral" id="input-gestor"></td>
                    </tr>
                </table>
            </div>

            <!-- Matriz de Risco -->
            <div class="mt-6 avoid-break border border-black p-4">
                <div class="section-header flex items-center gap-2">
                    <i data-lucide="grid" class="w-4 h-4"></i> 1. MATRIZ DE RISCO DA AUDITORIA
                </div>
                <div id="risk-matrix-container"></div>

                <div class="mt-4 bg-slate-50 border border-black p-4 text-center">
                    <h4 class="text-[9px] font-black uppercase text-slate-400 mb-2">Resultado da Análise de Risco</h4>
                    <div id="risk-result">
                        <p class="text-[10px] font-bold text-slate-700 mb-1">IMPACTO: GRAVÍSSIMO | PROBABILIDADE: (M. ALTO)</p>
                        <p class="text-[13px] font-black uppercase text-red-900">VALOR: 95% — RISCO EXTREMO</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="pdf-page-break"></div>

        <!-- PÁGINA 2: CONTEXTO E APONTAMENTOS -->
        <div class="content-padding p-6">
            <section class="avoid-break mb-8">
                <h2 class="section-header flex items-center gap-2">
                    <i data-lucide="info" class="w-4 h-4"></i> 2. DESCRIÇÃO PRELIMINAR E CONTEXTO
                </h2>
                <div class="border border-black p-3 bg-white mb-2">
                    <textarea id="input-preliminar" rows="6" placeholder="Cenário inicial...">Revisão das Políticas de Desconto
Avaliar, em nível estratégico, a adequação dos limites máximos de desconto, critérios de exceção e níveis de alçada atualmente vigentes, considerando margem, competitividade e risco.

Definição de Diretrizes e Alçadas
Deliberar sobre a necessidade de aprovação obrigatória da Diretoria ou de instância superior para concessões acima de determinado percentual ou valor absoluto.

Fortalecimento dos Controles Internos
Determinar a implementação ou o reforço de controles sistêmicos que impeçam a aplicação de descontos acima dos limites definidos sem autorização prévia.</textarea>
                </div>
                <div id="preliminar-images" class="grid grid-cols-2 gap-2"></div>
                <button onclick="addImage('preliminar')" class="no-print mt-2 text-[10px] font-bold text-red-700 flex items-center gap-1">
                    <i data-lucide="plus" class="w-3 h-3"></i> ADICIONAR FOTO AO CONTEXTO
                </button>
            </section>

            <section>
                <h2 class="section-header flex items-center gap-2">
                    <i data-lucide="alert-triangle" class="w-4 h-4"></i> 3. APONTAMENTOS E NÃO CONFORMIDADES
                </h2>
                <div id="findings-list" class="flex flex-col gap-6"></div>
            </section>
        </div>

        <div class="pdf-page-break"></div>

        <!-- PÁGINA 3: PARECER E ASSINATURAS -->
        <div class="content-padding p-6">
            <section class="avoid-break">
                <h2 class="section-header flex items-center gap-2">
                    <i data-lucide="check-circle" class="w-4 h-4"></i> 4. PARECER TÉCNICO E RECOMENDAÇÕES FINAIS
                </h2>
                <div id="final-opinions" class="flex flex-col gap-3 border border-black p-4 bg-slate-50/50"></div>
                <button onclick="addOpinion()" class="no-print mt-2 text-[10px] font-bold text-red-700 flex items-center gap-1">
                    <i data-lucide="plus" class="w-3 h-3"></i> ADICIONAR TÓPICO AO PARECER
                </button>

                <div class="mt-20 flex flex-col items-center text-center">
                    <div class="w-80 border-t-2 border-black pt-2">
                        <span class="text-sm font-black uppercase block">Francisco Tiago da Silva Ferreira</span>
                        <span class="text-[9px] text-gray-600 font-bold uppercase block mt-1">Auditor Interno Sênior / Especialista</span>
                        <span class="text-[9px] text-red-800 font-bold lowercase block underline">auditoriainterna@diamantesl.com</span>
                        <div class="mt-4 text-[8px] text-gray-400 font-bold uppercase">Assinado Eletronicamente — Criptografia SHA-256</div>
                    </div>
                </div>
            </section>

            <footer class="bg-slate-100 p-6 text-center border-t border-black mt-20">
                <p class="text-[8px] text-gray-400 font-black uppercase tracking-[0.5em]">Gerado Via Sistema de Auditoria — Diamante Lingerie</p>
            </footer>
        </div>
    </div>

    <div id="toast" class="hidden fixed top-4 right-4 bg-green-700 text-white px-6 py-3 shadow-2xl z-50 flex items-center gap-3">
        <i data-lucide="check" class="w-4 h-4"></i>
        <span id="toast-message" class="font-bold text-sm"></span>
    </div>

    <script>
        // Inicializa ícones
        lucide.createIcons();

        // Dados Iniciais
        let preliminarImages = [];
        let findings = [{
            id: Date.now(),
            proc: 'Auditoria Interna de Descontos em Vendas',
            evid: ['Análise do Ponto – Volume de Descontos por Loja\n\nA análise dos dados extraídos evidencia a concentração relevante de valores de desconto em um grupo específico de lojas e produtos.'],
            nc: ['Desvio na política de descontos manuais sem registro de justificativa técnica no sistema de vendas.'],
            acao: 'Implementar trava sistêmica para descontos superiores a 30% no PDV.',
            resp: 'Gerência de TI / Comercial',
            imgs: []
        }];
        let opinions = ['Parecer favorável à implementação imediata das travas sistêmicas conforme mapeado nos riscos financeiros.'];

        // Funções de UI
        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-message').innerText = msg;
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 3000);
        }

        // Matriz de Risco
        function renderMatrix() {
            const impactLabels = ['Mínimo', 'Leve', 'Moderado', 'Grave', 'Gravíssimo'];
            const probLabels = ['(FC) 1 M. Alto', '(FC) 0.8 Alto', '(FC) 0.6 Médio', '(FC) 0.4 Baixo', '(FC) 0.2 M. Baixo'];
            const levels = [
                ['MODERADO', 'ELEVADO', 'EXTREMO', 'EXTREMO', 'EXTREMO'],
                ['MODERADO', 'ELEVADO', 'ELEVADO', 'EXTREMO', 'EXTREMO'],
                ['BAIXO', 'MODERADO', 'ELEVADO', 'EXTREMO', 'EXTREMO'],
                ['BAIXO', 'BAIXO', 'MODERADO', 'ELEVADO', 'EXTREMO'],
                ['BAIXO', 'BAIXO', 'BAIXO', 'MODERADO', 'ELEVADO']
            ];
            const colors = [
                ['bg-emerald-600', 'bg-yellow-400', 'bg-red-600', 'bg-red-600', 'bg-red-700'],
                ['bg-emerald-600', 'bg-yellow-400', 'bg-yellow-400', 'bg-red-600', 'bg-red-700'],
                ['bg-emerald-500', 'bg-emerald-600', 'bg-yellow-400', 'bg-red-600', 'bg-red-600'],
                ['bg-emerald-500', 'bg-emerald-500', 'bg-emerald-600', 'bg-yellow-400', 'bg-red-600'],
                ['bg-emerald-500', 'bg-emerald-500', 'bg-emerald-500', 'bg-emerald-600', 'bg-yellow-400']
            ];
            const values = [['10%','30%','50%','75%','95%'],['8%','24%','40%','60%','76%'],['6%','18%','30%','45%','57%'],['4%','12%','20%','30%','38%'],['2%','6%','10%','15%','19%']];

            let html = `<table class="w-full border-collapse border border-gray-300"><thead><tr><th class="border border-gray-300"></th>`;
            impactLabels.forEach(l => html += `<th class="border border-gray-300 bg-gray-50 p-1 text-[7px] font-black uppercase">${l}</th>`);
            html += `</tr></thead><tbody>`;

            probLabels.forEach((p, r) => {
                html += `<tr><td class="border border-gray-300 bg-gray-50 p-1 text-[7px] font-bold text-center">${p}</td>`;
                levels[r].forEach((lvl, c) => {
                    const color = colors[r][c];
                    html += `<td class="border border-gray-300 p-0.5">
                        <button onclick="selectRisk('${values[r][c]}', '${lvl}', '${impactLabels[c]}', '${p}')" class="w-full h-10 flex flex-col justify-center items-center ${color} hover:opacity-80 transition-opacity">
                            <span class="text-[6px] font-black ${color.includes('yellow') ? 'text-gray-800' : 'text-white'}">${lvl}</span>
                            <span class="text-[9px] font-black ${color.includes('yellow') ? 'text-gray-900' : 'text-white'}">${values[r][c]}</span>
                        </button>
                    </td>`;
                });
                html += `</tr>`;
            });
            html += `</tbody></table>`;
            document.getElementById('risk-matrix-container').innerHTML = html;
        }

        function selectRisk(val, lvl, imp, prob) {
            document.getElementById('risk-result').innerHTML = `
                <p class="text-[10px] font-bold text-slate-700 mb-1">IMPACTO: ${imp.toUpperCase()} | PROBABILIDADE: ${prob.toUpperCase()}</p>
                <p class="text-[13px] font-black uppercase text-red-900">VALOR: ${val} — ${lvl}</p>
            `;
        }

        // Gerenciamento de Imagens
        function addImage(type, findingId = null) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = () => {
                    if (type === 'preliminar') {
                        preliminarImages.push(reader.result);
                        renderPrelimImages();
                    } else {
                        const f = findings.find(x => x.id === findingId);
                        f.imgs.push(reader.result);
                        renderFindings();
                    }
                };
                reader.readAsDataURL(file);
            };
            input.click();
        }

        function renderPrelimImages() {
            const container = document.getElementById('preliminar-images');
            container.innerHTML = preliminarImages.map((img, i) => `
                <div class="relative border border-gray-200">
                    <img src="${img}" class="w-full h-auto max-h-40 object-contain">
                    <button onclick="preliminarImages.splice(${i}, 1); renderPrelimImages()" class="no-print absolute top-1 right-1 bg-red-700 text-white p-1">
                        <i data-lucide="trash-2" class="w-3 h-3"></i>
                    </button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // Findings
        function renderFindings() {
            const container = document.getElementById('findings-list');
            container.innerHTML = findings.map((f, i) => `
                <div class="border border-black bg-white overflow-hidden avoid-break">
                    <div class="bg-slate-900 p-2 border-b border-black flex justify-between">
                        <span class="text-[10px] font-black uppercase text-white tracking-widest">Detalhamento Técnico ${i+1}</span>
                        <button onclick="findings = findings.filter(x => x.id !== ${f.id}); renderFindings()" class="no-print text-red-400"><i data-lucide="x" class="w-4 h-4"></i></button>
                    </div>
                    <div class="p-4 flex flex-col gap-4">
                        <div>
                            <label class="text-[8px] font-black text-gray-400 uppercase">Processo Auditado</label>
                            <div class="border border-black p-1 bg-slate-50">
                                <input type="text" value="${f.proc}" onchange="findings[${i}].proc = this.value; document.getElementById('display-main-title').innerText = this.value.toUpperCase()">
                            </div>
                        </div>
                        <div class="border border-black p-3">
                            <h4 class="text-[9px] font-black text-red-900 uppercase mb-2">Fatos / Evidências</h4>
                            ${f.evid.map((e, ei) => `<div class="flex gap-2 mb-2"><span class="text-[9px] font-bold">[${ei+1}]</span><textarea rows="1" onchange="findings[${i}].evid[${ei}] = this.value">${e}</textarea></div>`).join('')}
                            <button onclick="findings[${i}].evid.push(''); renderFindings()" class="no-print text-[9px] font-bold text-red-700">+ ADD FATO</button>
                        </div>
                        <div class="border border-black p-3">
                            <h4 class="text-[9px] font-black text-red-900 uppercase mb-2">Não Conformidades</h4>
                            ${f.nc.map((n, ni) => `<div class="flex gap-2 mb-2"><span class="text-[9px] font-bold">[${ni+1}]</span><textarea rows="1" onchange="findings[${i}].nc[${ni}] = this.value">${n}</textarea></div>`).join('')}
                            <button onclick="findings[${i}].nc.push(''); renderFindings()" class="no-print text-[9px] font-bold text-red-700">+ ADD NC</button>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            ${f.imgs.map((img, imi) => `
                                <div class="relative border border-gray-100 p-1">
                                    <img src="${img}" class="max-h-32 mx-auto">
                                    <button onclick="findings[${i}].imgs.splice(${imi}, 1); renderFindings()" class="no-print absolute top-1 right-1 bg-red-700 text-white p-1"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                                </div>
                            `).join('')}
                        </div>
                        <button onclick="addImage('finding', ${f.id})" class="no-print text-[9px] font-bold bg-slate-100 p-2 border border-dashed border-slate-300">VINCULAR IMAGEM AO APONTAMENTO</button>
                        <div class="flex gap-2 border-t border-black pt-4">
                            <div class="flex-1 border border-black p-2 bg-green-50/20"><label class="text-[7px] font-bold uppercase block">Plano de Ação</label><input type="text" value="${f.acao}" onchange="findings[${i}].acao = this.value"></div>
                            <div class="w-1/3 border border-black p-2 bg-green-50/20"><label class="text-[7px] font-bold uppercase block">Responsável</label><input type="text" value="${f.resp}" onchange="findings[${i}].resp = this.value"></div>
                        </div>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // Opinions
        function renderOpinions() {
            const container = document.getElementById('final-opinions');
            container.innerHTML = opinions.map((o, i) => `
                <div class="flex gap-3 border-b border-gray-100 pb-2 mb-2 last:border-0">
                    <span class="text-[9px] font-black text-slate-400">ITEM ${i+1}</span>
                    <textarea class="flex-1" rows="2" onchange="opinions[${i}] = this.value">${o}</textarea>
                    <button onclick="opinions.splice(${i}, 1); renderOpinions()" class="no-print text-red-400"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function addOpinion() { opinions.push(''); renderOpinions(); }

        // PDF
        function generatePDF() {
            const element = document.getElementById('printable-dashboard');
            
            // Remove foca de qualquer input antes de gerar
            document.activeElement.blur();

            const opt = {
                margin: 0,
                filename: `Laudo_Auditoria_${document.getElementById('input-rel').value}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 3, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                pagebreak: { mode: ['css', 'legacy'] }
            };

            showToast("Gerando PDF oficial...");
            html2pdf().set(opt).from(element).save().then(() => {
                showToast("PDF gerado com sucesso!");
            });
        }

        // Inicialização
        window.onload = () => {
            renderMatrix();
            renderPrelimImages();
            renderFindings();
            renderOpinions();
        };
    </script>
</body>
</html>
